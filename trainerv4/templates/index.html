<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Breakout Predictor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        @import url('https://rsms.me/inter/inter.css');
        .loader {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .sort-arrow {
            display: inline-block;
            width: 1em;
            text-align: center;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen py-12">

    <div class="w-full max-w-6xl mx-auto bg-white rounded-xl shadow-lg p-8">
        <div class="flex items-center mb-6">
            <svg class="h-10 w-10 text-indigo-600 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18 9 11.25l4.306 4.306a11.95 11.95 0 0 1 5.814-5.518l2.74-1.22m0 0-5.94-2.281m5.94 2.28-2.28 5.941" />
            </svg>
            <h1 class="text-3xl font-bold text-gray-900">Stock Breakout Predictor</h1>
        </div>

        {% if error %}
            <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6 rounded-md" role="alert">
                <p class="font-bold">Initialization Error</p>
                <p>{{ error }}</p>
            </div>
        {% endif %}

        <form id="ticker-form" class="mb-6">
            <label for="tickers" class="block text-sm font-medium text-gray-700 mb-2">Enter Ticker Symbols (comma-separated):</label>
            <textarea id="tickers" name="tickers" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out">AAPL,MSFT,NVDA,GOOGL,AMZN</textarea>
            <div class="flex items-center justify-start mt-4 space-x-3">
                <button type="submit" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out" {% if error %}disabled{% endif %}>
                    Analyze
                </button>
                <button type="button" id="load-from-file" class="bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition duration-150 ease-in-out" {% if error %}disabled{% endif %}>
                    Load from News Analysis
                </button>
                <button type="button" id="load-yahoo-most-active" class="bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition duration-150 ease-in-out" {% if error %}disabled{% endif %}>
                    Load Yahoo's Most Active
                </button>
                 <div id="loader" class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-8 w-8 hidden ml-4"></div>
            </div>
        </form>

        <div id="error-container" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md relative mb-4"></div>

        <div id="results-container">
            <!-- Results will be dynamically inserted here -->
        </div>
    </div>

    <script>
        const form = document.getElementById('ticker-form');
        const loadFromFileButton = document.getElementById('load-from-file');
        const loadYahooButton = document.getElementById('load-yahoo-most-active');
        const tickersTextarea = document.getElementById('tickers');
        const resultsContainer = document.getElementById('results-container');
        const errorContainer = document.getElementById('error-container');
        const loader = document.getElementById('loader');

        let currentResults = [];
        let sortState = { column: 'Ticker', direction: 'asc' };

        // --- Handle Form Submission for Analysis ---
        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            const tickers = tickersTextarea.value.split(',')
                .map(t => t.trim().toUpperCase())
                .filter(t => t);

            if (tickers.length === 0) {
                showError('Please enter at least one ticker symbol.');
                return;
            }

            loader.classList.remove('hidden');
            resultsContainer.innerHTML = '';
            errorContainer.classList.add('hidden');
            
            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tickers })
                });

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error || `HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();
                currentResults = data.results;
                sortState = { column: 'Ticker', direction: 'asc' };
                renderTable(currentResults);

            } catch (error) {
                console.error('Analysis failed:', error);
                showError(`Analysis failed: ${error.message}`);
            } finally {
                loader.classList.add('hidden');
            }
        });

        // --- Handle Button Click to Load Tickers from File ---
        loadFromFileButton.addEventListener('click', async () => {
            errorContainer.classList.add('hidden');
            try {
                const response = await fetch('/get-tickers-from-file');
                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error || 'Could not load tickers.');
                }
                const data = await response.json();
                if (data.tickers && data.tickers.length > 0) {
                    tickersTextarea.value = data.tickers.join(',');
                } else {
                    showError('No tickers found in the source file.');
                }
            } catch (error) {
                showError(`Failed to load tickers: ${error.message}`);
            }
        });

        // --- Handle Button Click to Load Yahoo Most Active Tickers ---
        loadYahooButton.addEventListener('click', async () => {
            errorContainer.classList.add('hidden');
            try {
                const response = await fetch('/get-yahoo-most-active');
                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error || 'Could not load tickers.');
                }
                const data = await response.json();
                if (data.tickers && data.tickers.length > 0) {
                    tickersTextarea.value = data.tickers.join(',');
                } else {
                    showError('No tickers were returned from Yahoo Finance.');
                }
            } catch (error) {
                showError(`Failed to load tickers: ${error.message}`);
            }
        });
        
        // --- Handle Table Sorting ---
        resultsContainer.addEventListener('click', (event) => {
            const header = event.target.closest('[data-sort-key]');
            if (!header) return;

            const columnKey = header.dataset.sortKey;

            if (sortState.column === columnKey) {
                sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortState.column = columnKey;
                sortState.direction = 'desc';
            }

            sortResults();
            renderTable(currentResults);
        });

        function parseSortValue(valueStr) {
            if (typeof valueStr !== 'string' || valueStr === 'N/A') {
                return -Infinity;
            }
            return parseFloat(valueStr.replace(/[^0-9.-]+/g, ""));
        }
        
        function sortResults() {
            const { column, direction } = sortState;
            currentResults.sort((a, b) => {
                const valA = parseSortValue(a[column]);
                const valB = parseSortValue(b[column]);
                if (valA < valB) return direction === 'asc' ? -1 : 1;
                if (valA > valB) return direction === 'asc' ? 1 : -1;
                return 0;
            });
        }

        // --- Main Rendering function ---
        function renderTable(results) {
            if (!results || results.length === 0) {
                resultsContainer.innerHTML = '<p class="text-center text-gray-500">No results to display.</p>';
                return;
            }

            const getArrow = (key) => {
                if (sortState.column !== key) return '';
                return sortState.direction === 'asc' ? '▲' : '▼';
            };

            const tableHeader = `
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-sort-key="Ticker">Ticker <span class="sort-arrow">${getArrow('Ticker')}</span></th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Price</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-sort-key="Confidence">Prediction Confidence <span class="sort-arrow">${getArrow('Confidence')}</span></th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-sort-key="Pred_Return">Predicted Return <span class="sort-arrow">${getArrow('Pred_Return')}</span></th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Signal</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">News Confidence</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">News Summary</th>
                    </tr>
                </thead>`;

            const tableBody = results.map(r => {
                let signalClass = 'text-gray-500';
                if (r.Signal === 'Potential Breakout') signalClass = 'text-green-600 font-semibold';
                if (r.Signal.includes('Error') || r.Signal.includes('Failed')) signalClass = 'text-red-600';
                
                return `
                    <tr class="bg-white border-b hover:bg-gray-50">
                        <td class="px-8 py-4 whitespace-nowrap text-sm font-medium text-gray-900"><a href="https://finance.yahoo.com/quote/${r.Ticker}">${r.Ticker}</a></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${r.Price || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${r.Confidence || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${r.Pred_Return || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm ${signalClass}">${r.Signal}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${r.News_Confidence || 'N/A'}</td>
                        <td class="px-6 py-4 text-sm text-gray-500 max-w-xs whitespace-normal">${r.News_Summary || 'N/A'}</td>
                    </tr>`;
            }).join('');

            resultsContainer.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">${tableHeader}<tbody class="divide-y divide-gray-200">${tableBody}</tbody></table>
                </div>`;
        }
        
        function showError(message) {
            errorContainer.textContent = message;
            errorContainer.classList.remove('hidden');
        }

    </script>
</body>
</html>

